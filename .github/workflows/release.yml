name: 'Release'

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            os_name: linux
            arch: x64
            
          # Windows x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            os_name: windows
            arch: x64
            
          # macOS Intel
          - platform: macos-latest
            target: x86_64-apple-darwin
            os_name: macos
            arch: x64
            
          # macOS Apple Silicon
          - platform: macos-latest
            target: aarch64-apple-darwin
            os_name: macos
            arch: arm64

    runs-on: ${{ matrix.platform }}
    name: Build ${{ matrix.os_name }}-${{ matrix.arch }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure bundled directory exists (non-Windows)
        if: runner.os != 'Windows'
        run: |
          # Some build scripts expect src-tauri/bundled to exist; create it if missing
          mkdir -p src-tauri/bundled/mariadb

      - name: Ensure bundled directory exists (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $path = 'src-tauri\\bundled\\mariadb'
          if (-not (Test-Path $path)) {
            New-Item -ItemType Directory -Path $path | Out-Null
            Write-Host "Created $path"
          } else {
            Write-Host "$path already exists"
          }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          target: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.os_name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2

      - name: Install frontend dependencies
        run: pnpm install

      - name: Prepare Monaco assets (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p src-tauri/bundled/monaco

          if [ -d "node_modules/monaco-editor/min/vs" ]; then
            cp -r node_modules/monaco-editor/min/vs/* src-tauri/bundled/monaco/
            echo "Copied monaco from node_modules/monaco-editor/min/vs to src-tauri/bundled/monaco"

          elif [ -d "node_modules/monaco-editor/min" ]; then
            # Some installs may place files directly in min
            cp -r node_modules/monaco-editor/min/* src-tauri/bundled/monaco/
            echo "Copied monaco from node_modules/monaco-editor/min to src-tauri/bundled/monaco"

          elif [ -d "src-tauri/bundled/monaco/vs" ]; then
            # Fallback: use any monaco already present under src-tauri (e.g., local dev copy)
            cp -r src-tauri/bundled/monaco/vs/* src-tauri/bundled/monaco/
            echo "Copied monaco from src-tauri/bundled/monaco/vs to src-tauri/bundled/monaco"

          else
            echo "Monaco not found locally. Attempting to download monaco-editor tarball from npm registry..."
            # Try to determine requested version from package.json (strip ^/~)
            VER=$(node -e "const p=require('./package.json').dependencies && require('./package.json').dependencies['monaco-editor'] || require('./package.json').devDependencies && require('./package.json').devDependencies['monaco-editor'] || '0.0.0'; console.log((p||'').replace(/^[^0-9]*/,''))")
            if [ -z "$VER" ] || [ "$VER" = "0.0.0" ]; then
              echo "Could not determine monaco version from package.json; defaulting to 0.55.1"
              VER=0.55.1
            fi
            URL="https://registry.npmjs.org/monaco-editor/-/monaco-editor-$VER.tgz"
            echo "Downloading $URL"
            if curl -fL "$URL" -o /tmp/monaco.tgz; then
              mkdir -p /tmp/monaco_extract
              tar -xzf /tmp/monaco.tgz -C /tmp/monaco_extract
              if [ -d /tmp/monaco_extract/package/min/vs ]; then
                cp -r /tmp/monaco_extract/package/min/vs/* src-tauri/bundled/monaco/
                echo "Extracted monaco min/vs into src-tauri/bundled/monaco"
              else
                echo "Downloaded package did not contain min/vs; skipping"
              fi
              rm -rf /tmp/monaco.tgz /tmp/monaco_extract
            else
              echo "Failed to download monaco tarball from $URL; continuing without Monaco (packaging may fail)"
            fi
          fi

      - name: Prepare Monaco assets (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $src = 'node_modules\monaco-editor\min\vs'
          if (Test-Path $src) {
            New-Item -ItemType Directory -Force -Path src-tauri\bundled\monaco | Out-Null
            # robocopy returns non-zero codes for successful copies; accept codes 0-3 as success
            robocopy $src src-tauri\bundled\monaco /E /NFL /NDL /NJH /NJS /NC /NS
            $rc = $LASTEXITCODE
            if ($rc -le 3) {
              Write-Host "Copied monaco from node_modules to src-tauri\\bundled\\monaco (robocopy exit $rc)"
              exit 0
            } else {
              Write-Host "robocopy returned exit code $rc - attempting download fallback"
            }
          } else {
            Write-Host "monaco-editor not found in node_modules; attempting download fallback"
          }

          # Download fallback: try npm registry tarball
          try {
            $pkg = (Get-Content package.json | ConvertFrom-Json).dependencies.'monaco-editor'
          } catch {
            $pkg = $null
          }
          if (-not $pkg) {
            try { $pkg = (Get-Content package.json | ConvertFrom-Json).devDependencies.'monaco-editor' } catch { $pkg = $null }
          }
          if (-not $pkg) { $pkg = '0.55.1' }
          $ver = $pkg -replace '^[^0-9]*',''
          if (-not $ver) { $ver = '0.55.1' }
          $url = "https://registry.npmjs.org/monaco-editor/-/monaco-editor-$ver.tgz"
          Write-Host "Downloading $url"
          try {
            Invoke-WebRequest -Uri $url -OutFile $env:TEMP\monaco.tgz -UseBasicParsing -ErrorAction Stop
            mkdir $env:TEMP\monaco_extract -Force | Out-Null
            tar -xzf $env:TEMP\monaco.tgz -C $env:TEMP\monaco_extract
            $pkgPath = Join-Path $env:TEMP "monaco_extract\package\min\vs"
            if (Test-Path $pkgPath) {
              New-Item -ItemType Directory -Force -Path src-tauri\\bundled\\monaco | Out-Null
              robocopy $pkgPath src-tauri\\bundled\\monaco /E /NFL /NDL /NJH /NJS /NC /NS | Out-Null
              Remove-Item $env:TEMP\monaco.tgz -Force
              Remove-Item $env:TEMP\monaco_extract -Recurse -Force
              Write-Host "Extracted monaco into src-tauri\\bundled\\monaco"
              exit 0
            } else {
              Write-Host "Downloaded package did not contain min/vs; continuing"
              exit 0
            }
          } catch {
            Write-Host "Failed to download or extract monaco: $_"
            exit 0
          }

      - name: Download MariaDB minimal bundle (Linux only)
        if: matrix.os_name == 'linux'
        run: |
          set -euo pipefail
          mkdir -p src-tauri/bundled/mariadb
          # Primary location: project releases (maintainers should upload the minimal bundle there)
          URL_GH="https://github.com/EV-OD/sqlIDE/releases/download/mariadb-bundles-v1/mariadb-linux-x86_64-minimal-10.6.24.tar.xz"
          echo "Attempting to download MariaDB bundle from $URL_GH"
          if curl -fL "$URL_GH" -o /tmp/mariadb.tar.xz; then
            echo "Downloaded MariaDB bundle from project release, extracting..."
            tar -xJf /tmp/mariadb.tar.xz -C src-tauri/bundled/mariadb
            echo "Extraction complete"
          else
            echo "ERROR: MariaDB bundle not available at $URL_GH"
            echo "This CI job requires the MariaDB minimal bundle to be present so the generated .deb includes offline MariaDB."
            echo "Please attach the file 'mariadb-linux-x86_64-minimal-10.6.24.tar.xz' to the release or update the URL."
            exit 1
          fi

      - name: Build frontend
        run: pnpm build

      - name: Ensure Rust target is installed
        run: |
          echo "Installing Rust target: ${{ matrix.target }}"
          rustup target add ${{ matrix.target }} || true

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_TARGET_DIR: src-tauri/target
        with:
          args: --target ${{ matrix.target }}

      - name: List built artifacts
        if: always()
        shell: bash
        run: |
          echo "=== Listing all built artifacts ==="
          find src-tauri/target/${{ matrix.target }}/release/bundle -type f 2>/dev/null || echo "No bundle directory found"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sql-ide-${{ matrix.os_name }}-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.rpm
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app
          if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.msi" -o \
            -name "*-setup.exe" -o \
            -name "*.dmg" \
          \) -exec cp {} release-files/ \;
          echo "=== Files to be released ==="
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          name: 'SqlIde Desktop ${{ github.ref_name }}'
          body: |
            ## Downloads
            
            - **Windows**: `.msi` (installer) or `.exe` (NSIS installer)
            - **macOS**: `.dmg` (Apple Silicon or Intel)
            - **Linux**: `.deb` (Debian/Ubuntu), `.rpm` (Fedora/RHEL), or `.AppImage` (Universal)
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
